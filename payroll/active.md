# 01_工资模块（v2025-09-17R7-HF2）
版本 v2025-09-17R7-HF2
生效：2025-09-17
打印版本 v2025-09-17R7-HF2

来源指针（用于自检）
- Pages（优先）：https://jj5638521.github.io/rules-mirror/payroll/active.md
- RAW（回退）：https://raw.githubusercontent.com/jj5638521/huijiang-assistant/main/rules/01_工资模块_latest.md?plain=1
- 破缓存：URL 末尾可追加参数（如 ?v=20250917）

# 与 HF1 的差异（Delta）
- 预支抵扣范围：由“仅抵工资”改为抵扣（工资 + 餐补 + 路补）之和。
- 当期应付：允许为负；若为负，必须在结算清单内输出强提示行：
  【当期应付为负：员工需返还或下期冲减｜负值金额：¥X】
- 预支清单：结算清单新增“预支抵扣（逐笔）”区；无预支时固定输出“无，−¥0”。
- 其余计薪口径、路补规则、十重校验等与 R7 保持一致（第10条改为“可为负但需强提示”）。

## 角色与单价（固定）
- 组长 300/天；组员 200/天。（v2025-08-18+）

## 名词与计薪口径（硬规则）
- 施工天：去重后的“施工”日期数；同日多条仅记1天。
- 未施工天：去重后的“未施工”日期数，仅计餐补，不计工资。
- 冲突消解：同日“施工/未施工”，施工优先保留1条。
- 工资天：= 施工天；未施工/休息/停工 不计工资。
- 工资：分段单价 × 对应施工天，按角色分段累计。
- 餐补：25×施工天 + 40×未施工天；假期“清障”当日餐补=0（备注触发时执行）。
- “结清离场”≠“项目已结束”：
  - 项目未结束：路补=0；“已付餐补”在结算中计0（仅计提，项目结束统一冲减）。
- 路补（项目制一次性，封顶200/人/项目）：
  - 仅在“项目已结束=是”时计入；跨项目分别计算。
  - 防双计：若存在与该人员相关的“路费/打车/网约车/车票”等有效报销，则本项目路补=0。
  - 无凭证/分摊不明默认口径（R2）：按200/人/项目记入；标注“凭证缺失/分摊不明（R2）”，列入差异清单；后补凭证后若可核算金额<200，下期冲减差额；>200仍以200封顶。
- 个人计入范围（v2025-08-25R1）：个人仅计入= 工资 + 餐补 + 路补；通行费/过路费/油费/中介劳务/其他=项目支出，不并入个人“已付/预支”。

## 已付/预支识别与抵扣（HF2）
- 三要素（主口径）：
  ① 报销类型 ∈ {工资(付款或微信文字截图)}；② 说明含〔预支/借支/预发〕；③ 报销人员=本人（姓名规范化匹配）。
- 映射层（可选，默认关闭）：说明含〔申请工资/申请…天工资/发工资/工资/领工资/借工资〕等可视作预支；但命中黑名单〔结算清单/当期应付/结清/尾款/补发/绩效〕则永不当预支。
- 风控（全部满足）：本人、项目期内、状态=已报销、金额不与餐/路交叉。
- 抵扣范围与公式（HF2）：
  设 W=工资，M=餐补，R=路补，P=当期匹配预支合计。
  当期应付 = (W + M + R) − P   （允许为负）
  预支抵扣合计 = P   （不封顶；逐笔列示）

## 备注驱动（v2025-08-22R1 摘要）
- 〔工资/预支/借支/先付/垫付/预付〕→ 工资预支（含“预支X天”换算）。
- 〔餐补/伙食/工作餐/餐费/AA〕→ 默认项目费用；若备注明确“个人已领取餐补X元”，标记“待项目结束一次性冲减”，项目未结束阶段个人“已付餐补”=0。
- 〔顺风车/拼车/路费/打车/滴滴/网约车/往返/车票〕→ 路补科目；自动识别往返与分摊，执行R2/封顶与凭证规则。
- 〔通行费/过路费/油费/加油〕→ 项目费用（不并入个人“已付/预支”）。
- 〔中介/劳务/介绍费/胡雲/胡云〕→ 触发中介识别规则（见下）。

## 中介识别（v2025-08-24R1 摘要）
- 姓名括号“姓名(中介人)”优先判定为中介。
- 组员且中介=是：工资=180/天，并对项目计入中介费20/天/人（项目费用）。
- 同人同日多中介或跨日中介人不一致→拦截；报销侧中介合计=Σ(20×中介人员施工天)，不等→列差异。

## 计算流程与「十重校验」（与 v2025-09-02R3 对齐）
1）资料完整性与格式：必须提供“施工表、报销表（=支付记录表）”，缺任一或字段缺失→阻断并给出缺失项清单。
2）周期覆盖与日期去重：单位=唯一日期。
3）出勤一致性与同日冲突：施工优先，未施工不计工资。
4）角色映射与分段单价：组长300/组员200；同日多角色→以组长优先保留，并输出纠错提示。
5）工资正反双算：A=∑(分段单价×对应施工天)；B=施工总天×加权单价；要求A=B，否则拦截。
6）餐补口径：25×施工天 + 40×未施工天；假期清障=0。
7）已付/预支归集与关键词分类（仅同项目+同人；不含“其他”）。
8）凭证唯一与“摘要=明细”；凭证号必须唯一可追溯。
9）路补规则与防双计：项目未结束=路补0；项目结束时取 min(200, 按凭证/分摊金额或R2默认)。若存在相关有效报销→路补=0。
10）边界红线：允许当期应付为负；若为负必须输出强提示行（见“输出模板”），否则阻断出单。

## 输出模板（固定行文｜便于截图）
{项目}｜工资清单（{姓名}｜{角色}）

1）周期：{开始日期}～{结束日期}｜单价：{日单价}元/天
2）出勤：
- 施工（{施工天数}天）：{施工日期列表}
- 未施工（{未施工天数}天）：{未施工日期列表或“无”}
3）金额：
- 工资：{日单价分段明细：组长×N天＝A元；组员×M天＝B元；合计＝A＋B}
- 餐补：25×{施工天数}＋40×{未施工天数}＝{施工餐补}＋{未施工餐补}＝{餐补合计}元
- 路补：{路补金额}元（项目未结束=0；项目结束取min(200,按凭证/分摊或R2默认)；若有相关有效报销→0）

预支抵扣（逐笔）：
{若有：- {YYYY-MM-DD} {说明/关键词}（凭证{编号}；金额=¥{ai}） −¥{ai}}
{若无：无，−¥0}
预支抵扣合计：−¥{P}

────────────────────────
应付合计：{工资合计} + {餐补合计} + {路补金额} + （−{P}）＝{当前应付金额}
{若 当前应付金额<0，必须追加下一行：}
【当期应付为负：员工需返还或下期冲减｜负值金额：¥{−当前应付金额}】

【计算口径与版本】
- 餐补策略：v2025-08-18R1；路补R2：v2025-08-22R2；个人计入范围：v2025-08-25R1；合并口径：v2025-09-02R3；本模块：v2025-09-17R7-HF2。

## 接口与最小输入（用于对话触发）
- 最小输入示例：
  “工资：刘凯｜组员｜项目已结束=否｜结清离场”
  模块自动提示并校验上传“施工表/报销表”；缺则阻断并输出缺失项与修复指引。
- 可选补充：
  “预支：3000（或 预支3天）｜备注：两天未供餐等” → 自动按规则换算与分类。

## 打印与留痕
- 必打印：版本号、生效日期、路补R2标记、来源指针URL（去敏感token）。
- 审计：保存“备注解析摘要”“预支逐笔与凭证映射（含拒绝原因）”“差异清单与阻断原因”。
- 负值留痕：当期应付为负时，额外记录 {worker, project, period, payable, refund_next=true}。
