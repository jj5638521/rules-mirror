# 01_工资模块（v2026-01-05R72）
版本 v2026-01-05R72
生效：2026-01-05
打印版本 v2026-01-05R72

## 变更说明（R72）
- 新增“确定性选表 + 可审计输出”：清洗表头后打分选表，输出选中的出勤/报销文件名、清洗表头与关键字段映射；无法唯一确定即 Hard 阻断并打印候选得分+表头摘要。
- AttendancePipe 兼容项目池：项目列多项目且未口令指定项目时 Hard 阻断并输出项目 Top10；指定项目后按项目过滤再计算。
- 是否施工值归一：出勤/施工/是/1/true → 是；待命/未施工/否/0/false/空 → 否；未知值 Hard 阻断并输出行号。
- 姓名规范化：支持“姓名(P007)”等后缀，规范化后参与匹配并记录审计。

## 输入与识别
- 输入仅允许两张表：施工表、支付记录表。
- 必填字段（施工表）：日期、姓名、是否施工（出勤模式可选；车辆字段仅用于单防撞审计）。
- 必填字段（支付表）：日期、金额、状态、类型、姓名、项目、凭证。
- 口令分流：工资：→单人出单；项目结算：→批量出单。
- 口令可选区块：角色（姓名=组长/组员）；固定日薪（姓名=金额）。
- 项目名识别：口令含“项目=XXX”优先；否则由 CSV 文件名去扩展与常见后缀兜底（含 _数据表_数据/_表格/_问卷/_收集结果）。
- 同日冲突：同人同日“施工/未施工”冲突，施工优先并记录审计。
- 选表规则：清洗表头后按关键词打分，无法唯一确定则阻断并输出候选得分与表头摘要。
- 项目池强约束：当检测到任一表存在项目列且唯一项目数>1，必须口令指定项目=xxx；否则 Hard 阻断并输出项目 Top10。

## AttendancePipe（考勤/模式/日期集合）
- 表头别名：姓名支持“实际出勤人员/实际施工人员/实际人员”；是否施工支持“今天是否施工/是否施工?/是否施工？”以及任意包含“是否施工”的列名。
- 人员回落：实际出勤人员为空时，依次从“组长(自动)/设标车驾驶员(默认)/防撞车驾驶员(默认)/辅助1(固定)/辅助2(固定)”取值。
- 出勤模式列：支持“出勤模式（填表用）/配置出勤模式（引用）”；文本含“单防撞”判为单防撞，否则全组。
- 是否施工归一：出勤/施工/是/1/true→是；待命/未施工/否/0/false/空→否；未知值阻断并输出行号+原值。
- 角色字段：角色/职务/岗位；可映射为组长/组员。
- 多人同格：姓名内含顿号/逗号/分号/空格/换行时拆分为多行，并记录“姓名拆分”审计。
- 空日期行跳过：合并表中的支付行如未填施工日期，不计为日期异常。
- 模式收口（项目×日期，优先出勤模式列）：
  - N_work=当日“是否施工=是”的去重人数。
  - 1<=N_work<=2 → 单防撞；N_work>=3 → 全组；N_work=0 → 全组。
- 输出四类日期集合（仅该人，且仅含该人有记录的日期）：
  - 单防撞｜出勤、单防撞｜未出勤、全组｜出勤、全组｜未出勤。

## PaymentPipe（支付/预支/状态/凭证）
- 状态白名单：已支付/已转账/已报销/完成/通过/成功/已结清/OK/已打款/审核通过。
- 状态字段允许任意字符串，仅用于有效/无效分类，不在 schema 层阻断。
- 状态/结果优先级：报销状态（优先）→ 报销结果（次级）。
- 状态为空且结果=通过 → 待确认（原因=通过但状态缺失）；结果=未通过 → 待确认（原因=未通过）。
- 状态为空且结果为空 → 待确认（原因=状态缺失）；状态非空但不在白名单 → 待确认（原因=状态无效）。
- 仅按“姓名+项目”归集合计（不按日期过滤）。
- 出勤行护栏（最高优先级）：若“是否施工”字段有值，或（施工日期非空且施工人员/实际出勤人员非空）→ 视为出勤行，直接跳过。
- 候选行判定：金额字段清洗后非空，或类型/状态/结果/凭证任一非空。
- 非候选行直接跳过，不参与金额/状态/schema 校验。
- 类型映射优先级：类型/报销类型/费用类型/科目/类别/费用类别（取首个命中列）。
- 类型必填：仅对支付候选行生效，类型空则 Hard 阻断并输出文件名/行号/金额/凭证/备注证据。
- wage-only 过滤：仅当类型字段包含“工资”才进入后续校验与汇总。
- 非工资类记录（餐补/伙食/路费/油费/ETC/项目费用等）全部直接跳过：
  - 不计入已付/预支。
  - 不产生待确认。
  - 不参与凭证唯一/金额数值化等阻断校验。
- 类别分流（最小可用）：工资 → 已付；预支 → 预支；其他（工资相关仍无法识别）→ 待确认（原因=类别待确认）。
- 凭证唯一：voucher|TEMP + 日期 + 金额 唯一；voucher 空且五元组重复 → 阻断。
- 金额解析：允许￥/元/逗号/空格；解析失败才阻断并记录原值与行号；金额缺失候选行进入待确认。

## 计价（最小可用）
- 角色来源优先级（锁死）：表内角色字段（若可映射到） > 口令角色覆盖 > 默认组员。
- 日薪来源优先级（锁死）：
  - 口令固定日薪 > 系统默认固定日薪映射(6人) > 表内角色日薪 > 角色默认(组长300/组员200) > 兜底。
- 系统默认固定日薪映射（姓名优先）：
  - 王怀宇300；余步云260；董峰300；董祥300；王怀良230；袁玉兵300。
- 全组工资：D_group * 全组出勤天数；全组未出勤工资=0。
- 单防撞工资：D_single_yes 默认270；D_single_no=round(0.5*D_single_yes)=135。
- 餐补：25×施工天 + 40×未施工天（仅全组参与）。
- 路补：项目已结束=是且路补口令=计算路补时，固定 200；否则 0。
- 应付=工资+餐补+路补-已付/预支（允许为负并提示负值金额）。

## 输出模板（固定行文）
- 输出两段纯文字（中间空行）：
  ① 详细版（给杰对账）含抬头/金额公式/已付预支/版本尾注/日期分组。
  ② 压缩版（发员工）工资/餐补/应付含公式，应付固定五项，日期逐日列出。
- 详细版抬头补充：
  - 项目已结束：是/否；路补口令：无路补/不计算路补/有路补。
  - 来源：出勤/报销文件名（合并表只显示一个文件名）。
- 待确认清单：默认只显示待确认汇总（含原因）；明细仅 verbose 或日志输出。
- 日期（模式→出勤）四类分组固定顺序，空类不打印。
- 版本尾注固定：计算口径版本 v2026-01-05R72｜阻断模式：Hard。
## 批量出单（项目结算）
- 入口：tools/demo_settle_project.py，仅扫描 data/当前。
- 人员集合：AttendancePipe人员 ∪ PaymentPipe人员（同项目过滤）。
- 输出目录：输出/当前/{项目名}/工资单_{姓名}.txt（详细版+压缩版）。
- 汇总索引：总人数、成功、阻断、待确认人数/条数（按原因统计）；阻断原因 code；待确认明细按人条数；固定日薪命中回显；角色来源回显。
- 批量模式硬约束：项目已结束=是（不满足则 L2 阻断）。

## 校核（≥10项）
- A 表头映射成功；B 项目名确定；C 凭证唯一；D 出勤冲突消解；E 应付反算一致；
  F 模式不混合；G 金额数值化；H 两版日期集合一致；M 单防撞必要字段满足；
  P 待确认条数提示；V 版本尾注存在；S schema 校验；L2 项目已结束=是（批量模式）。

## 审计留痕
- run_id（每次运行唯一）、规则版本、输入 hash、输出 hash。
- 默认 verbose=0：正文仅输出 run_id + 规则版本；其他审计明细写入 logs/{run_id}_{hash8}.json。
- verbose=1：正文输出清洗日志、完整审计留痕与 hash。
- show_audit=0 可隐藏审计留痕与日志路径输出。
- 自动纠错必须记录前后值与触发规则。
