# 01_工资模块（v2025-09-16R7）
版本 v2025-09-16R7  
生效：2025-09-16

## 角色与单价
- 组长 300/天；组员 200/天。

## 名词与计薪口径（硬规则）
- 有效施工天：去重后的“施工”日期数（同日多条仅记 1 天；若同日出现“施工/未施工”，以施工优先）。
- 工资天：= 有效施工天；未施工/休息/停工 **不计工资**。
- 未施工天：去重后的“未施工”日期数，仅计餐补，不计工资。
- 工资 = 角色单价 × 工资天。
- 餐补 = 25 × 施工天 + 40 × 未施工天。
- 路补 = 项目制一次性；仅“项目已结束=是”计入；封顶 200/人/项目。

## 计付时点（场景化）
- 场景 A：项目未结束 + 结清离场=是  
  → 当期应付 = 工资 − 预支(限额) + 餐补；路补=0（随项目结束统一结算）。
- 场景 B：项目未结束 + 未离场  
  → 当期应付 = 工资 − 预支(限额)；餐补仅计提不支付；路补=0。
- 场景 C：项目已结束  
  → 当期应付 = 工资 − 预支(限额) + 餐补 + 路补(≤200/人/项目)。

> 预支(限额)：不得超过当期“工资”（不含餐/路），超出部分自动限额并保留提示。

## 输出结构（呈现顺序｜R7）
> 通过开关控制顺序，不影响口径与数值。
- 当 `Feature.Layout_SettlementLast = on`（默认）：  
  **结论 → 计算口径 → 已付/预支明细 → 校验摘要 → 差异与待补字段 → 结算清单**
- 当 `Feature.Layout_SettlementLast = off`（回兼容旧版）：  
  **结论 → 计算口径 → 结算清单 → 已付/预支明细 → 校验摘要 → 差异与待补字段**

## 强制校验（防呆阻断）
1) 若【工资天 ≠ 施工天】或存在【未施工日期被计入工资】→ **报错并拒绝出数**，并回显冲突日期清单。  
2) 同日多状态冲突 → 以“施工”为准，同日仅记 1 天，并记录处理日志。  
3) 【项目未结束 + 结清离场=是】且餐补未入当期 → **自动修正为当期结清**并黄线提示。  
4) 预支 > 当期工资 → 自动限额并黄线提示。

## 状态词典与同义映射
- 允许值：{施工, 未施工, 休息, 请假, 停工}  
- 同义：施工 ← {干活, 上工, 加班(施工)}；未施工 ← {待命, 备勤, 现场未作业}  
- 白名单外状态 → 黄线预警。

## 出数页首“口径卡片”（固定回显，不可手改）
- 工资天 = **施工天 = __ 天**（未施工工资=0）  
- 餐补 = **25×施工天 + 40×未施工天**（场景：结清离场/未离场/已结束）  
- 路补 = **0 或 项目结束统一结算（≤200/人/项目）**  
- 使用规则 = **v2025-09-16R7**（RAW 链接）

## 工资天计算（R7 保持 R6-HF2 口径）
- **工资天=施工天（去重，按自然日）**。未施工/休息/停工/报销均不得计入工资天。
- **施工判定的唯一依据**：`今天是否施工 ∈ {是, Y, 1, TRUE}` **且** `实际施工人员` 列表**包含该姓名**（支持多人协同）。
- **同日冲突“施工优先”**：同一天既出现“施工=是”也出现“未施工/停工”，该人员当日记 **1 个施工天**、未施工天 **0**。
- **未施工天**：仅当日**不存在**“施工=是 & 人员含该姓名”，且出现“未施工/停工”等有效记载时，记 **1**（用于餐补 `40×未施工天`）。
- **报销排除**：`报销人员/费用类型/报销金额/用途` 等**一律不参与**施工与未施工的判定。
- **姓名规范化**：去空格、去括注（如“（组长）”）、统一简繁；允许别名映射（如“刘凯/刘恺”）。

### 字段规范化（列表字段）
- `实际施工人员` 视为**多人列表**，分隔符支持 `,` `，` `、` `;` `；`，保存前先去空格与全半角差异。

### 相关公式（不变）
- 工资：`日单价(组长300/组员200) × 施工天`
- 餐补：`25 × 施工天 + 40 × 未施工天`
- 预支抵扣：`min(预支合计, 当期工资)`（不含餐/路）

---

## 预支识别与抵扣口径（R7 更新）
**主口径（保持稳定）**：仅当同时满足**三要素**时，计为“预支”，可用于抵扣：  
1）报销类型 ∈ {`工资(付款或微信文字截图)`}；  
2）报销说明包含关键词：`预支｜借支｜预发`（大小写不敏感）；  
3）报销人员 == 结算对象姓名（忽略全/半角空格与括注）。  

**抵扣规则**：预支抵扣额 = `min(当期工资，不含餐/路；当期匹配预支合计)`；超出部分保留提示但**不抵餐/路**。

**企业默认建议**：**工资类型=历史已发工资**；只有当说明**明确包含**“预支/借支/预发”，或启用下面的“映射层”并通过风控时，才计入预支参与抵扣。

### 企业可选·映射层（默认关闭，可本地开启）
为减少“申请工资/发工资”等口语写法漏判，可选择开启**说明映射**：  
- 将以下常见表述映射为“预支”（仍需通过风控）：  
  `申请工资…｜申请…天工资…｜发工资…｜工资…元｜领工资…｜借工资…`  
- 开启后，这些表述在计算时**等价命中“预支”关键词**。

**风控条件（全部满足才计入抵扣）**  
- 报销人员=本人（姓名规范化后匹配）；  
- 凭证日期处于**项目执行期**；  
- 报销状态=**已报销**；  
- 金额不与餐/路交叉（若说明含餐/路，则**不纳入预支**）；  
- 场景控制：  
  - “未离场”默认**仅标记不抵扣**（需财务确认后转为预支）；  
  - “结清离场”默认**计入抵扣**。  

**反向黑名单（永不当预支）**  
说明命中：`结算清单｜当期应付｜结清｜尾款｜补发｜绩效` → 一律视为**历史发薪**，不做预支抵扣。

**填写建议**：一人一笔一行；日期 `YYYY-MM-DD`；金额为正值。若为冲销，请使用“结清/冲减”字样且**不要带“预支”**。

---

## 审计与强校验（R7 保持不变并补充提示）
- **强拦截 A**：发现某日把“报销记录”当“施工天”计入 → 阻断并红字提示。  
- **强拦截 B**：同日已判为“施工=是”，仍额外计入未施工天 → 阻断并红字提示。  
- **黄线提醒**：当期“报销记录占比>70% 且 施工天=0” → 仅提示，不阻断。  
- **审计留痕**：为每个记入的施工天输出 `date, worker, evidence_row_ids`。  
- **预支核对提示**：若检测到“满足三要素/或映射后满足”的报销记录却**未进入预支清单**，输出证据行号与原因（如风控未通过）。  
- **封顶提示**：预支合计 > 当期工资 → 已按“当期工资”封顶抵扣，并列示限额值。

## 输出规范：结算清单尾行（固定展示，默认开启）
- 分隔线使用**数学减号 U+2212**（而非 ASCII 连字符）。示例：  
  −−−−−−−−−−−−−−−−−−−−−−−  
- “预支抵扣”展示也使用 **U+2212 “−”** 号：  
  预支抵扣 … **−¥Z**

## 实现参考（伪代码｜R7）
    # 伪代码（使用四空格缩进，避免嵌套围栏）
    for worker in workers:
      days_work = {}
      days_nonwork = {}
      for row in rows_by_date:
        if row.今天是否施工 in {是,1,Y,TRUE} and worker in normalize(row.实际施工人员):
            days_work[date] = True
        else if row.今天是否施工 in {否,0,N,FALSE,停工} and worker in normalize(row.实际施工人员):
            if date not in days_work:
                days_nonwork[date] = True
      施工天 = count(keys(days_work))
      未施工天 = count(keys(days_nonwork) \ keys(days_work))

    # 预支识别（主口径）
    def is_prepay_main(reimb):
      return (reimb.类型 in {"工资(付款或微信文字截图)"} and
              contains_any(reimb.说明, {"预支","借支","预发"}) and
              normalize(reimb.报销人员) == normalize(worker.name))

    # 映射层（可选）
    def is_prepay_mapped(reimb):
      if not Feature.Prepay_Mapping: return False
      if contains_any(reimb.说明, {"结算清单","当期应付","结清","尾款","补发","绩效"}): return False
      if not (reimb.类型 in {"工资(付款或微信文字截图)"}): return False
      if not contains_any(reimb.说明, {"申请工资","申请","发工资","工资","领工资","借工资"}): return False
      return (normalize(reimb.报销人员) == normalize(worker.name)
              and reimb.日期 in project_period
              and reimb.状态 == "已报销")

    预支列表 = {r for r in 报销区 if is_prepay_main(r) or is_prepay_mapped(r)}
    预支抵扣额 = min(sum(预支列表.金额), 当期工资)  # 不含餐/路
