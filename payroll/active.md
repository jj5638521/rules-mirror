# 01_工资模块（v2025-11-25R60）
版本 v2025-11-25R60
生效：2025-11-25
打印版本 v2025-11-25R60

## 变更说明（R60）
- 压缩版工资/餐补/应付补齐公式（含 ×/=），应付公式固定五项。
- 日期（模式→出勤）改为逐日列出，不再按月折叠。

## 输入与识别
- 输入仅允许两张表：施工表、支付记录表。
- 必填字段（施工表）：日期、姓名、是否施工（车辆字段用于单防撞审计）。
- 必填字段（支付表）：日期、金额、状态、类型、姓名、项目、凭证。
- 项目名识别：口令含“项目=XXX”优先；否则由 CSV 文件名去扩展与常见后缀兜底（含 _数据表_数据/_表格/_问卷/_收集结果）。
- 同日冲突：同人同日“施工/未施工”冲突，施工优先并记录审计。

## AttendancePipe（考勤/模式/日期集合）
- 表头别名：姓名支持“实际出勤人员/实际施工人员/实际人员”；是否施工支持“今天是否施工/是否施工?/是否施工？”以及任意包含“是否施工”的列名。
- 多人同格：姓名内含顿号/逗号/空格时拆分为多行，并记录“姓名拆分”审计。
- 空日期行跳过：合并表中的支付行如未填施工日期，不计为日期异常。
- 模式收口（项目×日期）：
  - N_work=当日“是否施工=是”的去重人数。
  - 1<=N_work<=2 → 单防撞；N_work>=3 → 全组；N_work=0 → 全组。
- 输出四类日期集合（仅该人，且仅含该人有记录的日期）：
  - 单防撞｜出勤、单防撞｜未出勤、全组｜出勤、全组｜未出勤。

## PaymentPipe（支付/预支/状态/凭证）
- 状态白名单：已支付/已转账/已报销/完成/通过/成功/已结清/OK/已打款/审核通过。
- 仅按“姓名+项目”归集合计（不按日期过滤）。
- 候选行判定：金额字段清洗后非空，或类型/状态/凭证/备注任一非空。
- 非候选行直接跳过，不参与金额/状态/schema 校验。
- 类别分流（最小可用）：
  - 工资/预支/餐补(伙食/盒饭/工作餐) → 计入个人已付/预支。
  - 路补(路补/顺风车/拼车/打车/滴滴/路费) → 路补候选，油费/ETC 仍归项目费用。
  - 路费类 → 项目费用；无效状态 → 待确认。
- 凭证唯一：voucher|TEMP + 日期 + 金额 唯一；voucher 空且五元组重复 → 阻断。
- 金额解析：允许￥/元/逗号/空格；解析失败才阻断并记录原值与行号；金额缺失候选行进入待确认。

## 计价（最小可用）
- 日薪映射（姓名优先）：
  - 王怀宇300；余步云260；董峰300；董祥300；王怀良230；袁玉兵300。
- 角色日薪（姓名未命中时使用）：
  - 组长300；组员200。
- 全组工资：D_group * 全组出勤天数；全组未出勤工资=0。
- 单防撞工资：D_single_yes 默认270；D_single_no=round(0.5*D_single_yes)=135。
- 餐补：25×施工天 + 40×未施工天（仅全组参与）。
- 路补：项目已结束=是且存在路补记录时，min(200, 路补有效金额合计)。
- 应付=工资+餐补+路补-已付/预支（允许为负并提示负值金额）。

## 输出模板（固定行文）
- 输出两段纯文字（中间空行）：
  ① 详细版（给杰对账）含抬头/金额公式/已付预支/版本尾注/日期分组。
  ② 压缩版（发员工）工资/餐补/应付含公式，应付固定五项，日期逐日列出。
- 详细版抬头补充：
  - 项目已结束：是/否；路补口令：无路补/不计算路补/有路补。
  - 来源：出勤/报销文件名（合并表只显示一个文件名）。
- 日期（模式→出勤）四类分组固定顺序，空类不打印。
- 版本尾注固定：计算口径版本 v2025-11-25R60｜阻断模式：Hard。

## 校核（≥10项）
- A 表头映射成功；B 项目名确定；C 凭证唯一；D 出勤冲突消解；E 应付反算一致；
  F 模式不混合；G 金额数值化；H 两版日期集合一致；M 单防撞必要字段满足；
  P 待确认条数提示；V 版本尾注存在；S schema 校验。

## 审计留痕
- run_id（每次运行唯一）、规则版本、输入 hash、输出 hash。
- 默认 verbose=0：正文仅输出 run_id + 规则版本；其他审计明细写入 logs/{run_id}_{hash8}.json。
- verbose=1：正文输出清洗日志、完整审计留痕与 hash。
- show_audit=0 可隐藏审计留痕与日志路径输出。
- 自动纠错必须记录前后值与触发规则。
