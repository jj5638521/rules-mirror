# 01_工资模块（v2025-09-15R6-HF4）
版本 v2025-09-15R6-HF4
生效：2025-09-15

## 角色与单价
- 组长 300/天；组员 200/天。

## 名词与计薪口径（硬规则）
- 有效施工天：去重后的“施工”日期数（同日多条仅记 1 天；若同日出现“施工/未施工”，以施工优先）。
- 工资天：= 有效施工天；未施工/休息/停工 **不计工资**。
- 未施工天：去重后的“未施工”日期数，仅计餐补，不计工资。
- 工资 = 角色单价 × 工资天。
- 餐补 = 25 × 施工天 + 40 × 未施工天。
- 路补 = 项目制一次性；仅“项目已结束=是”计入；封顶 200/人/项目。

## 计付时点（场景化）
- 场景 A：项目未结束 + 结清离场=是  
  → 当期应付 = 工资 − 预支(限额) + 餐补；路补=0（随项目结束统一结算）。
- 场景 B：项目未结束 + 未离场  
  → 当期应付 = 工资 − 预支(限额)；餐补仅计提不支付；路补=0。
- 场景 C：项目已结束  
  → 当期应付 = 工资 − 预支(限额) + 餐补 + 路补(≤200/人/项目)。

> 预支(限额)：不得超过当期“工资”（不含餐/路），超出部分自动限额并保留提示。

## 输出结构（呈现顺序｜R6-HF4）
> 通过开关控制顺序，不影响口径与数值。
- 当 `Feature.Layout_SettlementLast = on`（默认）：  
  **结论 → 计算口径 → 已付/预支明细 → 校验摘要 → 差异与待补字段 → 结算清单**
- 当 `Feature.Layout_SettlementLast = off`（回兼容旧版）：  
  **结论 → 计算口径 → 结算清单 → 已付/预支明细 → 校验摘要 → 差异与待补字段**

## 强制校验（防呆阻断）
1) 若【工资天 ≠ 施工天】或存在【未施工日期被计入工资】→ **报错并拒绝出数**，并回显冲突日期清单。  
2) 同日多状态冲突 → 以“施工”为准，同日仅记 1 天，并记录处理日志。  
3) 【项目未结束 + 结清离场=是】且餐补未入当期 → **自动修正为当期结清**并黄线提示。  
4) 预支 > 当期工资 → 自动限额并黄线提示。

## 状态词典与同义映射
- 允许值：{施工, 未施工, 休息, 请假, 停工}  
- 同义：施工 ← {干活, 上工, 加班(施工)}；未施工 ← {待命, 备勤, 现场未作业}  
- 白名单外状态 → 黄线预警。

## 出数页首“口径卡片”（固定回显，不可手改）
- 工资天 = **施工天 = __ 天**（未施工工资=0）  
- 餐补 = **25×施工天 + 40×未施工天**（场景：结清离场/未离场/已结束）  
- 路补 = **0 或 项目结束统一结算（≤200/人/项目）**  
- 使用规则 = **v2025-09-15R6-HF4**（RAW 链接）
  
## 工资天计算（R6-HF2 保持不变）
- **工资天=施工天（去重，按自然日）**。未施工/休息/停工/报销均不得计入工资天。
- **施工判定的唯一依据**：`今天是否施工 ∈ {是, Y, 1, TRUE}` **且** `实际施工人员` 列表**包含该姓名**（支持多人协同）。
- **同日冲突“施工优先”**：同一天既出现“施工=是”也出现“未施工/停工”，该人员当日记 **1 个施工天**、未施工天 **0**。
- **未施工天**：仅当日**不存在**“施工=是 & 人员含该姓名”，且出现“未施工/停工”等有效记载时，记 **1**（用于餐补 `40×未施工天`）。
- **报销排除**：`报销人员/费用类型/报销金额/用途` 等**一律不参与**施工与未施工的判定。
- **姓名规范化**：去空格、去括注（如“（组长）”）、统一简繁；允许别名映射（如“刘凯/刘恺”）。

### 字段规范化（列表字段）
- `实际施工人员` 视为**多人列表**，分隔符支持 `,` `，` `、` `;` `；`，保存前先去空格与全半角差异。

### 相关公式（不变）
- 工资：`日单价(组长300/组员200) × 施工天`
- 餐补：`25 × 施工天 + 40 × 未施工天`
- 预支抵扣：`min(预支合计, 当期工资)`（不含餐/路）

## 审计与强校验（R6-HF2 保持不变）
- **强拦截 A**：发现某日把“报销记录”当“施工天”计入 → 阻断并红字提示。
- **强拦截 B**：同日已判为“施工=是”，仍额外计入未施工天 → 阻断并红字提示。
- **黄线提醒**：当期“报销记录占比>70% 且 施工天=0” → 仅提示，不阻断。
- **审计留痕**：为每个记入的施工天输出 `date, worker, evidence_row_ids` 以便回溯。

## 实现参考（伪代码｜R6-HF2）
```pseudo
for worker in workers:
  days_work = {}
  days_nonwork = {}
  for row in rows_by_date:
    if row.今天是否施工 in {是,1,Y,TRUE} and worker in normalize(row.实际施工人员):
        days_work[date] = True
    else if row.今天是否施工 in {否,0,N,FALSE,停工} and worker in normalize(row.实际施工人员):
        if date not in days_work:
            days_nonwork[date] = True
  施工天 = count(keys(days_work))
  未施工天 = count(keys(days_nonwork) \ keys(days_work))
