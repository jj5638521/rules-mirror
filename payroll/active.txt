# 01_工资模块（v2025-11-25R55）
版本 v2025-11-25R55
生效：2025-11-25
打印版本 v2025-11-25R55

## 变更说明（R55）
- 支付表候选行过滤仅基于“金额/类型/状态/凭证/备注”等支付指示字段。
- 仅对候选支付行做金额数值化与 schema 校验；空金额候选行进入待确认，不硬阻断。
- 金额解析保持对￥/元/逗号/空格的兼容。

## 输入与识别
- 输入仅允许两张表：施工表、支付记录表。
- 必填字段（施工表）：日期、姓名、是否施工（车辆字段用于单防撞审计）。
- 必填字段（支付表）：日期、金额、状态、类型、姓名、项目、凭证。
- 项目名识别：口令含“项目=XXX”优先；否则由 CSV 文件名去扩展与常见后缀兜底（含 _数据表_数据/_表格/_问卷/_收集结果）。
- 同日冲突：同人同日“施工/未施工”冲突，施工优先并记录审计。

## AttendancePipe（考勤/模式/日期集合）
- 表头别名：姓名支持“实际出勤人员/实际施工人员/实际人员”；是否施工支持“今天是否施工/是否施工?/是否施工？”以及任意包含“是否施工”的列名。
- 多人同格：姓名内含顿号/逗号/空格时拆分为多行，并记录“姓名拆分”审计。
- 空日期行跳过：合并表中的支付行如未填施工日期，不计为日期异常。
- 模式收口（项目×日期）：
  - N_work=当日“是否施工=是”的去重人数。
  - 1<=N_work<=2 → 单防撞；N_work>=3 → 全组；N_work=0 → 全组。
- 输出四类日期集合（仅该人）：
  - 单防撞｜出勤、单防撞｜未出勤、全组｜出勤、全组｜未出勤。

## PaymentPipe（支付/预支/状态/凭证）
- 状态白名单：已支付/已转账/已报销/完成/通过/成功/已结清/OK/已打款/审核通过。
- 仅按“姓名+项目”归集合计（不按日期过滤）。
- 候选行判定：金额字段清洗后非空，或类型/状态/凭证/备注任一非空。
- 非候选行直接跳过，不参与金额/状态/schema 校验。
- 类别分流（最小可用）：
  - 工资/预支/餐补(伙食/盒饭/工作餐) → 计入个人已付/预支。
  - 路费类 → 项目费用；无效状态 → 待确认。
- 凭证唯一：voucher|TEMP + 日期 + 金额 唯一；voucher 空且五元组重复 → 阻断。
- 金额解析：允许￥/元/逗号/空格；解析失败才阻断并记录原值与行号；金额缺失候选行进入待确认。

## 计价（最小可用）
- 日薪映射（姓名优先）：
  - 王怀宇300；余步云260；董峰300；董祥300；王怀良230；袁玉兵300。
- 角色日薪（姓名未命中时使用）：
  - 组长300；组员200。
- 全组工资：D_group * 全组出勤天数；全组未出勤工资=0。
- 单防撞工资：D_single_yes 默认270；D_single_no=round(0.5*D_single_yes)=135。
- 餐补：当前口径恒为 0。
- 路补：当前口径恒为 0（项目已结束仅做记录）。
- 应付=工资+餐补+路补-已付/预支（允许为负并提示负值金额）。

## 输出模板（固定行文）
- 输出两段纯文字（中间空行）：
  ① 详细版（给杰对账）含金额公式、已付/预支合计、校核摘要、版本尾注。
  ② 压缩版（发员工）0值整段隐藏。
- 详细版文末追加“日期（模式→出勤）”四类分组，空类不打印。
- 版本尾注固定：计算口径版本 v2025-11-25R55｜阻断模式：Hard。

## 校核（≥10项）
- A 表头映射成功；B 项目名确定；C 凭证唯一；D 出勤冲突消解；E 应付反算一致；
  F 模式不混合；G 金额数值化；H 两版日期集合一致；M 单防撞必要字段满足；
  P 待确认条数提示；V 版本尾注存在；S schema 校验。

## 审计留痕
- run_id（由 input_hash 生成）、规则版本、输入 hash、输出 hash。
- 自动纠错必须记录前后值与触发规则。
